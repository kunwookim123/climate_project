# base_map.py
import folium
import pandas as pd
import os
import re

class BaseMap:
    def __init__(self, data_path: str):
        """CSVë‚˜ ë¦¬ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¡œë“œ"""
        self.data_path = data_path  # íŒŒì¼ëª…ì—ì„œ ì—°ë„ ì¶”ì •ìš©
        self.df = self.load_data(data_path)

    def load_data(self, data_path):
        """CSV ë˜ëŠ” ë¦¬ìŠ¤íŠ¸ í˜•íƒœ ë°ì´í„° ì½ê¸° ë° ìë™ êµ¬ì¡° ë³€í™˜"""
        # âœ… ìƒëŒ€ê²½ë¡œ â†’ ì ˆëŒ€ê²½ë¡œ ìë™ ë³€í™˜
        if isinstance(data_path, str) and not os.path.isabs(data_path):
            base_dir = os.path.dirname(os.path.abspath(__file__))
            data_path = os.path.join(base_dir, data_path)

        if isinstance(data_path, str) and data_path.endswith(".csv"):
            df = pd.read_csv(data_path, encoding="utf-8-sig")
            df = self.auto_convert(df)
            return df

        elif isinstance(data_path, list):
            return pd.DataFrame(
                data_path,
                columns=["ì—°ë„", "ì›”", "ì¼", "ì§€ì—­", "ìœ„ë„", "ê²½ë„", "ê°’"]
            )
        else:
            raise ValueError("ì§€ì›í•˜ì§€ ì•ŠëŠ” ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.")

    def auto_convert(self, df):
        """CSV êµ¬ì¡°ê°€ ë‹¤ë¥¼ ë•Œ ìë™ ë³€í™˜"""
        cols = df.columns

        # âœ… â€œì¼ì‹œâ€ ì»¬ëŸ¼ì´ ìˆëŠ” ê²½ìš° â†’ ì—°/ì›” ë¶„ë¦¬
        if "ì¼ì‹œ" in cols:
            try:
                # â€œ2021-07â€ í˜•ì‹ ì²˜ë¦¬
                if df["ì¼ì‹œ"].str.match(r"\d{4}-\d{2}").any():
                    df["ì—°ë„"] = df["ì¼ì‹œ"].str.split("-").str[0].astype(int)
                    df["ì›”"] = df["ì¼ì‹œ"].str.split("-").str[1].astype(int)
                else:
                    # â€œJan-21â€ í˜•ì‹ ì²˜ë¦¬
                    df["ì›”"] = df["ì¼ì‹œ"].str.split("-").str[0]
                    df["ì—°ë„"] = "20" + df["ì¼ì‹œ"].str.split("-").str[1]
                    month_map = {
                        "Jan": 1, "Feb": 2, "Mar": 3, "Apr": 4, "May": 5, "Jun": 6,
                        "Jul": 7, "Aug": 8, "Sep": 9, "Oct": 10, "Nov": 11, "Dec": 12
                    }
                    df["ì›”"] = df["ì›”"].map(month_map)
                df["ì¼"] = 1
            except Exception as e:
                print(f"âš ï¸ ì¼ì‹œ íŒŒì‹± ì˜¤ë¥˜: {e}")
                df["ì—°ë„"], df["ì›”"], df["ì¼"] = None, None, 1

        # âœ… â€œì—°ë„â€ê°€ ì—†ìœ¼ë©´ íŒŒì¼ëª…ì—ì„œ ì¶”ì •
        if "ì—°ë„" not in df.columns:
            match = re.search(r"(\d{4})", self.data_path)
            df["ì—°ë„"] = int(match.group(1)) if match else None

        # âœ… â€œì›”â€ NaN ìˆìœ¼ë©´ 1ì›”ë¡œ ëŒ€ì²´
        if "ì›”" not in df.columns or df["ì›”"].isna().any():
            df["ì›”"] = df["ì›”"].fillna(1) if "ì›”" in df.columns else 1

        # âœ… ì£¼ìš” ê°’ ì»¬ëŸ¼ ìë™ íƒìƒ‰
        value_col = None
        for c in cols:
            if "í‰ê· ì§€ë©´ì˜¨ë„" in c or "ì¼ì‚¬" in c or "ê°•ìˆ˜" in c:
                value_col = c
                break
        if value_col:
            df.rename(columns={value_col: "ê°’"}, inplace=True)

        # âœ… ì§€ì—­ëª… ì»¬ëŸ¼ í†µì¼
        if "ì§€ì ëª…" in cols:
            df.rename(columns={"ì§€ì ëª…": "ì§€ì—­"}, inplace=True)
        elif "ì§€ì " in cols and "ì§€ì—­" not in cols:
            df.rename(columns={"ì§€ì ": "ì§€ì—­"}, inplace=True)

        # ğŸ”´ ì „êµ­ ê´€ì¸¡ì†Œ ìœ„ë„Â·ê²½ë„ ìë™ ë§¤í•‘ -----------------------------
        location_data = {
            "ì„œìš¸": [37.5665, 126.9780], "ë¶€ì‚°": [35.1796, 129.0756],
            "ëŒ€êµ¬": [35.8714, 128.6014], "ì¸ì²œ": [37.4563, 126.7052],
            "ê´‘ì£¼": [35.1595, 126.8526], "ëŒ€ì „": [36.3504, 127.3845],
            "ìš¸ì‚°": [35.5384, 129.3114], "ì„¸ì¢…": [36.4801, 127.2892],
            "ì¶˜ì²œ": [37.8813, 127.7298], "ê°•ë¦‰": [37.7519, 128.8761],
            "ì†ì´ˆ": [38.2070, 128.5910], "ì›ì£¼": [37.3422, 127.9202],
            "ì²­ì£¼": [36.6424, 127.4890], "ì „ì£¼": [35.8242, 127.1480],
            "í¬í•­": [36.0190, 129.3430], "ì°½ì›": [35.2280, 128.6810],
            "ì§„ì£¼": [35.1800, 128.1080], "ì œì£¼": [33.4996, 126.5312],
            "ê±°ì œ": [34.8806, 128.6217], "í†µì˜": [34.8553, 128.4330],
            "ê¹€í•´": [35.2280, 128.8890], "ì–‘ì‚°": [35.3342, 129.0370],
            "ì‚¬ì²œ": [35.0031, 128.0640], "ê³ ì„±": [38.3786, 128.4675],
            "ì² ì›": [38.1460, 127.3139], "ë™í•´": [37.5073, 129.1245],
            "ì‚¼ì²™": [37.4474, 129.1675], "íƒœë°±": [37.1640, 128.9857],
            "í‰ì°½": [37.3700, 128.3900], "í™ì²œ": [37.6900, 127.8800],
            "ì •ì„ ": [37.3800, 128.6600], "ì˜ì›”": [37.1830, 128.4670],
            "ì¶©ì£¼": [36.9714, 127.9250], "ì œì²œ": [37.1325, 128.1900],
            "ë³´ì€": [36.4890, 127.7310], "ì˜¥ì²œ": [36.3010, 127.5730],
            "ìƒì£¼": [36.4100, 128.1600], "ì•ˆë™": [36.5680, 128.7290],
            "êµ¬ë¯¸": [36.1196, 128.3448], "ì˜ì£¼": [36.8057, 128.6241],
            "ì˜ì²œ": [35.9733, 128.9380], "ë¬¸ê²½": [36.5860, 128.1870],
            "ê¹€ì²œ": [36.1218, 128.1190], "ì˜ˆì²œ": [36.6552, 128.4530],
            "ë°€ì–‘": [35.5039, 128.7467], "ê±°ì°½": [35.6866, 127.9090],
            "í•©ì²œ": [35.5665, 128.1650], "ë‚¨í•´": [34.8371, 127.8924],
            "ìˆœì²œ": [34.9507, 127.4870], "ê´‘ì–‘": [34.9406, 127.6955],
            "ì—¬ìˆ˜": [34.7604, 127.6622], "ëª©í¬": [34.8118, 126.3922],
            "í•´ë‚¨": [34.5730, 126.5980], "ì§„ë„": [34.4854, 126.2646],
            "ì™„ë„": [34.3210, 126.7470], "ê³ í¥": [34.6110, 127.2820],
            "ë³´ì„±": [34.7680, 127.0810], "ë‚˜ì£¼": [35.0280, 126.7170],
            "í•¨í‰": [35.0650, 126.5160], "ì˜ê´‘": [35.2770, 126.5090],
            "ì¥ì„±": [35.3020, 126.7830], "ë‹´ì–‘": [35.3210, 126.9880],
            "ìˆœì°½": [35.3710, 127.1380], "ë‚¨ì›": [35.4120, 127.3920],
            "ì„ì‹¤": [35.6060, 127.2820], "ë¬´ì£¼": [35.9440, 127.6610],
            "ì •ì": [35.5660, 126.8550], "ê³ ì°½": [35.4350, 126.7010],
            "êµ°ì‚°": [35.9670, 126.7360], "ìµì‚°": [35.9410, 126.9570],
            "ë¶€ì—¬": [36.2760, 126.9100], "ì„œì‚°": [36.7840, 126.4500],
            "ë³´ë ¹": [36.3490, 126.6020], "í™ì„±": [36.6010, 126.6620],
            "ì˜ˆì‚°": [36.6880, 126.8440], "ì²œì•ˆ": [36.8150, 127.1550],
            "ì•„ì‚°": [36.7900, 127.0040], "ê³µì£¼": [36.4460, 127.1190],
            "ë…¼ì‚°": [36.1830, 127.0970], "ê³„ë£¡": [36.2740, 127.2480],
            "ì„œì²œ": [36.0780, 126.6930], "ë‹¨ì–‘": [36.9850, 128.3650],
            "ì˜ì •ë¶€": [37.7390, 127.0460], "ì–‘í‰": [37.4910, 127.4870],
            "ì´ì²œ": [37.2780, 127.4420], "ìš©ì¸": [37.2410, 127.1770],
            "í‰íƒ": [36.9940, 127.0850], "ìˆ˜ì›": [37.2636, 127.0286],
            "ì„±ë‚¨": [37.4200, 127.1260], "ì˜ì™•": [37.3440, 126.9680],
            "ì•ˆì–‘": [37.3890, 126.9250], "ê´‘ëª…": [37.4780, 126.8640],
            "ì•ˆì‚°": [37.3160, 126.8310], "ì‹œí¥": [37.3800, 126.8020],
            "ê³ ì–‘": [37.6580, 126.8310], "íŒŒì£¼": [37.7600, 126.7740],
            "ê¹€í¬": [37.6540, 126.6830], "ë‚¨ì–‘ì£¼": [37.6360, 127.2160],
            "ê°€í‰": [37.8310, 127.5120], "í¬ì²œ": [37.8940, 127.2000],
            "ë™ë‘ì²œ": [37.9010, 127.0600]
        }

        # âœ… ìœ„ë„/ê²½ë„ ì»¬ëŸ¼ ì—†ì„ ê²½ìš° ìƒì„±
        if "ìœ„ë„" not in df.columns:
            df["ìœ„ë„"] = None
        if "ê²½ë„" not in df.columns:
            df["ê²½ë„"] = None

        # âœ… ìœ„ë„Â·ê²½ë„ ìë™ ë§¤í•‘
        df["ìœ„ë„"] = df["ì§€ì—­"].map(lambda x: location_data.get(x, [None, None])[0])
        df["ê²½ë„"] = df["ì§€ì—­"].map(lambda x: location_data.get(x, [None, None])[1])

        # âœ… ì¼ìê°€ ì—†ìœ¼ë©´ 1ì¼ë¡œ ì„¤ì •
        if "ì¼" not in df.columns:
            df["ì¼"] = 1

        # âœ… ëˆ„ë½ëœ ì»¬ëŸ¼ ìƒì„± í›„ ì •ë ¬
        keep_cols = ["ì—°ë„", "ì›”", "ì¼", "ì§€ì—­", "ìœ„ë„", "ê²½ë„", "ê°’"]
        for col in keep_cols:
            if col not in df.columns:
                df[col] = None

        # âœ… ì¢Œí‘œ ì—†ëŠ” í–‰ ì œê±° (folium ì˜¤ë¥˜ ë°©ì§€)
        if "ìœ„ë„" in df.columns and "ê²½ë„" in df.columns:
            df = df.dropna(subset=["ìœ„ë„", "ê²½ë„"])

        return df[keep_cols]

    def filter_data(self, year, month, day):
        """ì„ íƒí•œ ë‚ ì§œë¡œ ë°ì´í„° í•„í„°ë§"""
        return self.df[
            (self.df["ì—°ë„"].astype(int) == year)
            & (self.df["ì›”"].astype(int) == month)
            & (self.df["ì¼"].astype(int) == day)
        ]

    def create_map(self, lat=36.5, lon=127.8, zoom=7):
        """ê¸°ë³¸ ì§€ë„ ìƒì„±"""
        return folium.Map(location=[lat, lon], zoom_start=zoom)
