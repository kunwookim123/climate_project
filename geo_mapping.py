import pandas as pd
import fiona
from shapely.geometry import Point, shape
import pyproj

# ------------------------------------------------------------------------------------
# 1) 좌표 불러오기 (WGS84)
# ------------------------------------------------------------------------------------
coords = pd.read_csv("data/좌표.csv")

# ------------------------------------------------------------------------------------
# 2) SHP 경계 (EPSG:5179) 불러오기
# ------------------------------------------------------------------------------------
shp_path = "data/bnd_sido_00_2024_2Q/bnd_sido_00_2024_2Q.shp"
sido = list(fiona.open(shp_path))

features = []
for f in sido:
    geom = shape(f['geometry'])
    props = f['properties']
    features.append((geom, props))

# ------------------------------------------------------------------------------------
# 3) WGS84 → EPSG:5179 변환기 생성
# ------------------------------------------------------------------------------------
proj_4326 = pyproj.CRS("EPSG:4326")     # 위도/경도
proj_5179 = pyproj.CRS("EPSG:5179")     # SHP 좌표계
transformer = pyproj.Transformer.from_crs(proj_4326, proj_5179, always_xy=True)

# ------------------------------------------------------------------------------------
# 4) 점 → 시도 매핑 함수
# ------------------------------------------------------------------------------------
def find_sido(lat, lon):
    # 위경도(4326) → 5179 변환
    x, y = transformer.transform(lon, lat)
    p = Point(x, y)

    for geom, props in features:
        if geom.contains(p):
            return props["SIDO_NM"]   # ★ 최종 정답 필드명

    return "UNKNOWN"

# ------------------------------------------------------------------------------------
# 5) 전체 매핑 수행
# ------------------------------------------------------------------------------------
coords["시도"] = coords.apply(lambda r: find_sido(r["위도"], r["경도"]), axis=1)

# ------------------------------------------------------------------------------------
# 6) 결과 저장
# ------------------------------------------------------------------------------------
coords.to_csv("관측소_시도매핑.csv", index=False)
print("매핑 완료! 관측소_시도매핑.csv 생성됨")
